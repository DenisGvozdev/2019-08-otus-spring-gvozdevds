<!doctype html>
<!--[if lt IE 7 ]>
<html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>
<html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>
<html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>
<html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml"> <!--<![endif]-->
<head>
    <meta charset="utf-8" name="viewport" content="width = 1050, user-scalable = no"/>
    <script type="text/javascript" src="extras/jquery.min.1.7.js"></script>
    <script type="text/javascript" src="extras/modernizr.2.5.3.min.js"></script>

    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/read.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="flipbook-viewport">
    <div class="container">
        <div class="flipbook"></div>
    </div>
</div>

<div id="book" th:text="${book}" hidden></div>

<script type="text/javascript">

    function saveCommentBookPage(object) {
        $.ajax({
            url: "/pagecomment",
            type: "POST",
            data: {
                "bookId": object.form[0].value,
                "page": object.form[1].value,
                "comment": object.form[3].value
            },
            enctype: 'application/json',
            success: function (comment) {
                if (comment != null) {
                    alert("Комментарий успешно добавлен");
                } else {
                    alert("Ошибка добавления комментария");
                }
            },
            error: function (e) {
                alert("Ошибка сохранения комментария: " + e.toString());
            }
        });
    }

    $(document).ready(function () {

        var book = JSON.parse($("#book")[0].textContent);
        var bookId = book.bookId;
        var pageList = book.pageList;

        $.each(pageList, function (key, value) {

            var image = value.image;
            var text = value.text;
            var page = value.page;

            if (image != null) {
                var divImage = "<div style=\"background-image:url(data:image/png;base64," + image + ")\"></div>";
                $(".flipbook").append(divImage);

            } else if (text != null) {
                var divText = "<div>" +
                    "<table style='height: 400px; width: 100%;'>" +
                    "   <tr style='height: 30%; width: 100%;'>" +
                    "       <td style='text-align: left; padding: 20px 20px 10px 20px;'>" +
                    "           <form id=\"formSaveCommentBook" + bookId + page + "\" " +
                    "               enctype=\"multipart/form-data\" " +
                    "               action=\"\"" +
                    "               mode=\"\" " +
                    "               method=\"\">" +
                    "               <input name=\"bookId\" type=\"hidden\" value=\"" + bookId + "\"/>" +
                    "               <input name=\"page\" type=\"hidden\" value=\"" + page + "\"/>" +
                    "               <div class=\"commentAndButtonDiv\">" +
                    "                   <div class=\"titleDiv\">" +
                    "                       <label class=\"labelInput\">Стр. " + page + "</label>" +
                    "                   </div>" +
                    "                   <div class=\"buttonDiv\">" +
                    "                       <button " +
                    "                           type=\"button\"" +
                    "                           class=\"refButton\"" +
                    "                           onclick=\"saveCommentBookPage(this)\" >" +
                    "                           <span class=\"glyphicon glyphicon-plus\"></span>" +
                    "                           <span><strong>Оставить комментарий</strong></span>" +
                    "                       </button>" +
                    "                   </div>" +
                    "                   <div class=\"commentDiv\">" +
                    "                           <textarea id=\"description" + page + "\"" +
                    "                               name=\"comment\" " +
                    "                               rows=\"2\" " +
                    "                               cols=\"50\" " +
                    "                               class=\"commentBookTextArea\"" +
                    "                               field=\"\">" +
                    "                           </textarea>" +
                    "                   </div>" +
                    "               </div>" +
                    "           </form>" +
                    "       </td>" +
                    "    </tr>" +
                    "   <tr style='height: 70%; width: 100%'>" +
                    "       <td style='text-align: justify; padding: 20px 20px 20px 20px'>" + text + "</td>" +
                    "    </tr>" +
                    "</table>" +
                    "</div>";

                $(".flipbook").append(divText);
            }
        });
        loadApp();

    });

    function loadApp() {
        $('.flipbook').turn({
            width: 922,
            height: 600,
            elevation: 50,
            gradients: true,
            autoCenter: true
        });
    }

    yepnope({
        test: Modernizr.csstransforms,
        yep: ['lib/turn.js'],
        nope: ['lib/turn.html4.min.js'],
        both: ['css/basic.css'],
        complete: loadApp
    });

</script>
</body>
</html>